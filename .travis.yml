services:
  - docker
language: rust
rust:
- stable
cache: cargo

# All Rust build architectures are defined here
matrix:
  include:
  - env: TARGET=x86_64-unknown-linux-gnu
    os: linux
  - env: TARGET=i686-apple-darwin
    os: osx
    osx_image: xcode10
  - env: TARGET=x86_64-apple-darwin
    os: osx
    osx_image: xcode10
  - env: TARGET=x86_64-pc-windows-msvc
    os: windows
  - env: TARGET=armv7-unknown-linux-gnueabihf
    os: linux
    addons:
      apt:
        packages:
        - gcc-arm-linux-gnueabihf
install:
  - export PATH="$PATH:$HOME/.cargo/bin"
  - rustup target add $TARGET || true
    
# This is the script that will be run on each matrix element
script:
  - |
    if [ $TARGET = "x86_64-unknown-linux-gnu" ]; then
      echo "Running on $TARGET, so running tests!"
      cargo test
    fi
  - |
    if [ $TARGET = "x86_64-pc-windows-msvc" ]; then
      cargo build --target $TARGET --verbose --release
    elif [ $TARGET = "i686-apple-darwin" ]; then
      cargo build --target $TARGET --verbose --release
    elif [ $TARGET = "x86_64-apple-darwin" ]; then
      cargo build --target $TARGET --verbose --release
    else
      cross build --target $TARGET --verbose --release
    fi
  - mkdir -p target/executable
  - cp target/${TARGET}/release/rrss2imap target/executable/rrss2imap-${TARGET}
  - ls -la target/executable

# Once the Rust packages are built, here they are deployed
deploy:
  provider: releases
  api_key:
    secure: "ZqX4/j/XYQWc+HwtUWL7zqDzJo+HODV80ZKaQ/CakUUe2sa8zTf8m4IlqxCmN47+4k/hPH1nNUC/1frPatnn3rrnyHled5L0081jZozHhIxqSkS2VfkmrSNJqXFfDg1HviGgUv+kKx0ncdJ7f0O10OK31Wz6TWiogWm3pbpmEWuW9zi9PngUSvFQYHI4lAND7qnixiA/Xr6FlHrdxZLyxd4nENS99mVCALPwuo1i/H7mvNBOHMfoZwp3Oh21AyOBvtF0izLyzNz6a2JUIbnFKiMcqspR5UxDcR/kXBNQb5NIMCjWTpclZ9JKW5aED4l32P0nyGrk0e+TB81WeCDFd0S90Dnpm9cHSlCaAvFQLerQ6R5AQOWy58qkAK3pCwmeh56fGjtY47xO5qc+nAdsONYlwfBUUqw8ZlLByPS1urcDQX0sBD4XZADnGcHPYbBpEoXwO1hGRP8YrXKJVAvjeTZ97HAw7UIesu2du5Lt7EFidioBVL+fS4LIlT4/+oNYeqylbTmxv6H/6BEWTV9dao5763pZs6AlknmDMBT8Pv57DFixu85XK5A2I5Yne4zqGzwth+U37iTDW40l17SCYa09j4s6W2QLdMnHz3OBQfSJraiarI0vEVj3wOLxagFsrbbr7PZZjIIetBTeNmtCDQDsUZ6R4ttN/87glvYe934="
  file_glob: true
  file: target/executable/*
  skip_cleanup: true
  overwrite: true
  # This way, the release is not directly visible
  draft: true
  # Release name on body
  name: "$TRAVIS_TAG"
  # Body is created by git journal !
#  body: "$JOURNAL"
  on:
    repo: Riduidel/rrss2imap
    tags: true

branches:
  except:
  - "/^untagged/"
